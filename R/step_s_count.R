#' Count reads in genomic segments (CACTI-S)
#'
#' A wrapper around \code{Rsubread::featureCounts} to quantify reads in the SAF segments
#' generated by \code{cacti_s_create_segments}.
#'
#' By default, this runs with settings optimized for CACTI-S:
#' \itemize{
#'   \item \code{-F SAF}: Uses the SAF format provided.
#'   \item \code{--read2pos 5}: Reduces reads to their 5' end.
#'   \item \code{--primary}: Counts only primary alignments.
#'   \item \code{--ignoreDup}: Ignores duplicate reads.
#' }
#'
#' @param file_bams Character vector of BAM file paths.
#' @param file_saf Path to the SAF annotation file (from \code{cacti_s_create_segments}).
#' @param file_counts_out Output path for the counts matrix.
#' @param threads Number of threads for featureCounts.
#' @param isPairedEnd Logical. If \code{TRUE}, fragments are counted instead of reads.
#'   Default is \code{FALSE}.
#' @param ... Additional arguments passed to \code{Rsubread::featureCounts}.
#'
#' @return Invisibly returns the counts matrix; writes \code{file_counts_out}.
#'
#' @examples
#' \dontrun{
#' # Locate test data bundled in the package
#' file_saf <- system.file("extdata/test_results", "test_segments.saf", package = "cacti")
#' file_bam1 <- system.file("extdata", "Sample1.bam", package = "cacti")
#' file_bam2 <- system.file("extdata", "Sample2.bam", package = "cacti")
#' file_bam3 <- system.file("extdata", "Sample3.bam", package = "cacti")
#' file_bam4 <- system.file("extdata", "Sample4.bam", package = "cacti")
#'
#' # Define output file
#' file_out <- "inst/extdata/test_results/test_raw_counts.txt"
#'
#' # Run counting
#' if (file.exists(file_bam1) && file.exists(file_saf)) {
#'   cacti_s_count(
#'     file_bams = c(file_bam1, file_bam2, file_bam3, file_bam4),
#'     file_saf  = file_saf,
#'     file_counts_out = file_out
#'   )
#'
#'   # Check result
#'   head(read.table(file_out, header = TRUE))
#' }
#' }
#' @export
cacti_s_count <- function(
    file_bams,
    file_saf,
    file_counts_out,
    threads = 1,
    isPairedEnd = FALSE,
    ...
) {
  if (!requireNamespace("data.table", quietly = TRUE)) stop("data.table required.")
  if (!requireNamespace("Rsubread", quietly = TRUE)) stop("Rsubread required.")


  message("Counting reads for ", length(file_bams), " BAM files...")
  message("Settings: SAF format | Primary Only | Ignore Dups | Read2Pos = 5")

  # Run featureCounts
  fc_res <- Rsubread::featureCounts(
    files = file_bams,
    annot.ext = file_saf,
    isGTFAnnotationFile = FALSE, # -F SAF
    read2pos = 5,                # --read2pos 5
    primaryOnly = TRUE,          # --primary
    ignoreDup = TRUE,            # --ignoreDup
    nthreads = threads,
    isPairedEnd = isPairedEnd,
    ...
  )

  # Combine Annotation + Counts
  anno <- fc_res$annotation
  counts <- fc_res$counts

  if (ncol(counts) != length(file_bams)) {
    warning("Number of output columns does not match number of input BAMs.")
  }

  out_df <- cbind(anno, counts)

  # Write out
  data.table::fwrite(out_df, file = file_counts_out, sep = "\t", quote = FALSE)

  message("Success! Counts written to: ", file_counts_out)

  invisible(out_df)
}
