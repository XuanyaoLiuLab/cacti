<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>CACTI-S: segment-based data preparation &amp; mapping • cacti</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="CACTI-S: segment-based data preparation &amp; mapping">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cacti</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Vignettes</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/liliw-w/cacti/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>CACTI-S: segment-based data preparation &amp; mapping</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/liliw-w/cacti/blob/HEAD/vignettes/cacti_s_prep.Rmd" class="external-link"><code>vignettes/cacti_s_prep.Rmd</code></a></small>
      <div class="d-none name"><code>cacti_s_prep.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <strong>CACTI-S (Segment-based)</strong> pipeline is designed to
process raw sequencing data (BAM files) into normalized phenotype
matrices and QTL mapping. It handles the multi-step pipeline:</p>
<ul>
<li>
<strong>Segmentation</strong>: Tile the genome into fixed-size
segments (e.g., 1kb, 5kb).</li>
<li>
<strong>Reads counting</strong>: Count reads from raw BAM files into
these segments.</li>
<li>
<strong>Preprocessing</strong>: Perform quality control and
normalization.</li>
<li>
<strong>Mapping</strong>: Run cis-QTL mapping of the segments using
<code>MatrixEQTL</code> to generate summary statistics required the
multivariate CACTI model.</li>
</ul>
<p>This vignette explains:</p>
<ol style="list-style-type: decimal">
<li>The overall workflow.</li>
<li>The expected input files.</li>
<li>The output files produced by the pipeline.</li>
<li>Example usage with bundled toy data under
<code>inst/extdata/</code>.</li>
</ol>
<p>The main user-facing function in this vignette is:</p>
<ul>
<li>
<code><a href="../reference/cacti_s_prep.html">cacti_s_prep()</a></code> — a master wrapper that automates the
entire workflow from BAM files to summary statistics.</li>
</ul>
<p>Lower-level building blocks are:</p>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th align="left">Function</th>
<th align="left">Role</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong><code>cacti_s_prep</code></strong></td>
<td align="left"><strong>Wrapper</strong></td>
<td align="left">Master function that runs the entire pipeline (Steps
1–4) sequentially.</td>
</tr>
<tr class="even">
<td align="left"><code>cacti_s_create_segments</code></td>
<td align="left">Step 1</td>
<td align="left">Generates fixed-size segments to divide the
genome.</td>
</tr>
<tr class="odd">
<td align="left"><code>cacti_s_count</code></td>
<td align="left">Step 2</td>
<td align="left">Quantifies reads in segments using
<code><a href="https://rdrr.io/pkg/Rsubread/man/featureCounts.html" class="external-link">Rsubread::featureCounts</a></code>.</td>
</tr>
<tr class="even">
<td align="left"><code>cacti_s_preprocess</code></td>
<td align="left">Step 3</td>
<td align="left">Performs QC and normalization.</td>
</tr>
<tr class="odd">
<td align="left"><code>cacti_s_map_cis</code></td>
<td align="left">Step 4</td>
<td align="left">Runs cis-QTL mapping using
<code>MatrixEQTL</code>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="part-1-overview-of-the-cacti-s-pipeline">Part 1: Overview of the CACTI-S pipeline<a class="anchor" aria-label="anchor" href="#part-1-overview-of-the-cacti-s-pipeline"></a>
</h2>
<p>The CACTI-S pipeline has three main steps:</p>
<ol style="list-style-type: decimal">
<li><strong>Define and quantify genomic segments</strong></li>
</ol>
<ul>
<li><p>Segmentation: Tiling the genome into fixed-size segments (e.g.,
1kb, 5kb) or using a custom BED file.</p></li>
<li><p>Quantification: Counting reads in these segments for every sample
(BAM file) using <code>Rsubread</code>.</p></li>
<li><p>Output: A raw counts matrix (Rows = Segments, Columns =
Samples).</p></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><strong>Preprocess and normalize phenotypes</strong></li>
</ol>
<ul>
<li><p>QC &amp; Filtering &amp; Normalization</p></li>
<li><p>Output: A normalized phenotype matrix ready for QTL
mapping.</p></li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Cis-QTLs mapping</strong></li>
</ol>
<ul>
<li><p>Input: Normalized phenotype matrix, genotype data (VCF), and
covariates.</p></li>
<li><p>Process: Runs `MatrixEQTL for every variant–segment pair within a
defined cis window (e.g., 100kb).</p></li>
<li><p>Output: Cis-QTL summary statistics (Z-scores), which serve as the
primary input for the CACTI multivariate test.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="part-2-quick-start">Part 2: Quick start<a class="anchor" aria-label="anchor" href="#part-2-quick-start"></a>
</h2>
<p>For most users, the <code><a href="../reference/cacti_s_prep.html">cacti_s_prep()</a></code> function is the most
convenient way to run the pipeline. It automates all steps and manages
intermediate files.</p>
<div class="section level3">
<h3 id="locate-test-data">1. Locate test data<a class="anchor" aria-label="anchor" href="#locate-test-data"></a>
</h3>
<p>We will use the small test files bundled with the <code>cacti</code>
package. In a real analysis, these would be your actual BAM and VCF
paths.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Locate the 4 test BAM files</span></span>
<span><span class="va">bam_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"cacti"</span><span class="op">)</span>,</span>
<span>  pattern <span class="op">=</span> <span class="st">"Sample.*\\.bam$"</span>,</span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Locate Genotype (VCF), Covariate, and Peak files</span></span>
<span><span class="va">file_vcf</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"test_geno.vcf"</span>, package <span class="op">=</span> <span class="st">"cacti"</span><span class="op">)</span></span>
<span><span class="va">file_cov</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"test_cov.txt"</span>, package <span class="op">=</span> <span class="st">"cacti"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bam_files</span>, <span class="va">file_vcf</span>, <span class="va">file_cov</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Sample1.bam"   "Sample2.bam"   "Sample3.bam"   "Sample4.bam"  </span></span>
<span><span class="co">#&gt; [5] "test_geno.vcf" "test_cov.txt"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-the-pipeline">2. Run the pipeline<a class="anchor" aria-label="anchor" href="#run-the-pipeline"></a>
</h3>
<p>We will run the pipeline with the following settings:</p>
<ul>
<li>
<strong>Genome</strong>: hg19<br>
</li>
<li>
<strong>Segment Size</strong>: 5kb<br>
</li>
<li>
<strong>Filter Mode</strong>: <code>cpm_threshold</code> (keep
segments with peak intensity CPM &gt; 1 in &gt; 20% of samples)</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cacti_s_prep.html">cacti_s_prep</a></span><span class="op">(</span></span>
<span>  file_bams <span class="op">=</span> <span class="va">bam_files</span>,</span>
<span>  file_vcf <span class="op">=</span> <span class="va">file_vcf</span>,</span>
<span>  file_cov <span class="op">=</span> <span class="va">file_cov</span>,</span>
<span>  </span>
<span>  out_dir <span class="op">=</span> <span class="st">"../inst/extdata/test_results"</span>,</span>
<span>  out_prefix <span class="op">=</span> <span class="st">"test"</span>,</span>
<span></span>
<span>  <span class="co"># Pipeline Parameters</span></span>
<span>  genome <span class="op">=</span> <span class="st">"hg19"</span>,</span>
<span>  segment_size <span class="op">=</span> <span class="st">"5kb"</span>,</span>
<span>  filter_mode <span class="op">=</span> <span class="st">"cpm_threshold"</span>,</span>
<span>  min_cpm <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  min_prop <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span></span>
<span>  <span class="co"># Use 1 thread for this small demo</span></span>
<span>  threads <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt;  CACTI-S Preparation Pipeline</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; Output Directory: ../inst/extdata/test_results</span></span>
<span><span class="co">#&gt; Input BAMs: 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 1] Creating Genomic Segments...</span></span>
<span><span class="co">#&gt; Using built-in chromosome sizes for: hg19</span></span>
<span><span class="co">#&gt; Generating 5kb segments for 22 autosomes (chr1-chr22)...</span></span>
<span><span class="co">#&gt; Success! Created 576216 segments. Saved to: ../inst/extdata/test_results/test_segments.saf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 2] Counting Reads...</span></span>
<span><span class="co">#&gt; Counting reads for 4 BAM files...</span></span>
<span><span class="co">#&gt; Settings: SAF format | Primary Only | Ignore Dups | Read2Pos = 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         ==========     _____ _    _ ____  _____  ______          _____  </span></span>
<span><span class="co">#&gt;         =====         / ____| |  | |  _ \|  __ \|  ____|   /\   |  __ \ </span></span>
<span><span class="co">#&gt;           =====      | (___ | |  | | |_) | |__) | |__     /  \  | |  | |</span></span>
<span><span class="co">#&gt;             ====      \___ \| |  | |  _ &lt;|  _  /|  __|   / /\ \ | |  | |</span></span>
<span><span class="co">#&gt;               ====    ____) | |__| | |_) | | \ \| |____ / ____ \| |__| |</span></span>
<span><span class="co">#&gt;         ==========   |_____/ \____/|____/|_|  \_\______/_/    \_\_____/</span></span>
<span><span class="co">#&gt;        Rsubread 2.20.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; //========================== featureCounts setting ===========================\\</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||             Input files : 4 BAM files                                      ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||                           Sample1.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample2.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample3.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample4.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||              Paired-end : no                                               ||</span></span>
<span><span class="co">#&gt; ||        Count read pairs : no                                               ||</span></span>
<span><span class="co">#&gt; ||              Annotation : test_segments.saf (SAF)                          ||</span></span>
<span><span class="co">#&gt; ||      Dir for temp files : .                                                ||</span></span>
<span><span class="co">#&gt; ||                 Threads : 1                                                ||</span></span>
<span><span class="co">#&gt; ||                   Level : meta-feature level                               ||</span></span>
<span><span class="co">#&gt; ||      Multimapping reads : counted                                          ||</span></span>
<span><span class="co">#&gt; ||     Multiple alignments : primary alignment only                           ||</span></span>
<span><span class="co">#&gt; || Multi-overlapping reads : not counted                                      ||</span></span>
<span><span class="co">#&gt; ||   Min overlapping bases : 1                                                ||</span></span>
<span><span class="co">#&gt; ||          Read reduction : to 5' end                                        ||</span></span>
<span><span class="co">#&gt; ||        Duplicated Reads : ignored                                          ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; \\============================================================================//</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; //================================= Running ==================================\\</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Load annotation file test_segments.saf ...                                 ||</span></span>
<span><span class="co">#&gt; ||    Features : 576216                                                       ||</span></span>
<span><span class="co">#&gt; ||    Meta-features : 576216                                                  ||</span></span>
<span><span class="co">#&gt; ||    Chromosomes/contigs : 22                                                ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample1.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 50                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 50 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample2.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 75                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 75 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample3.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 50                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 50 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample4.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 75                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 75 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Write the final count table.                                               ||</span></span>
<span><span class="co">#&gt; || Write the read assignment summary.                                         ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; \\============================================================================//</span></span>
<span><span class="co">#&gt; Success! Counts written to: ../inst/extdata/test_results/test_raw_counts.txt</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 3] Preprocessing (QC, Filter, Normalize)...</span></span>
<span><span class="co">#&gt; === Starting Preprocessing ===</span></span>
<span><span class="co">#&gt;   Input: ../inst/extdata/test_results/test_raw_counts.txt</span></span>
<span><span class="co">#&gt;   Filter Mode: cpm_threshold</span></span>
<span><span class="co">#&gt;   Cleaned sample names: Sample1, Sample2, Sample3...</span></span>
<span><span class="co">#&gt;   Initial Features: 576216</span></span>
<span><span class="co">#&gt;   Initial Samples:  4</span></span>
<span><span class="co">#&gt;   Features after removing all-zeros: 2</span></span>
<span><span class="co">#&gt;   Filtering by intensity: CPM &gt; 1 in &gt; 20% samples</span></span>
<span><span class="co">#&gt;   Features kept: 2</span></span>
<span><span class="co">#&gt;   Standardizing (Z-score per feature)...</span></span>
<span><span class="co">#&gt;   Rank Normalizing (INT per sample)...</span></span>
<span><span class="co">#&gt; Success! Processed data written to: ../inst/extdata/test_results/test_pheno_norm.txt</span></span>
<span><span class="co">#&gt; Success! Processed data meta written to: ../inst/extdata/test_results/test_pheno_norm_meta.txt</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 4] Mapping Cis-QTLs...</span></span>
<span><span class="co">#&gt; Preparing phenotype data...</span></span>
<span><span class="co">#&gt;   Phenotype samples: 4</span></span>
<span><span class="co">#&gt; Converting VCF to genotype matrix...</span></span>
<span><span class="co">#&gt; Preparing covariates...</span></span>
<span><span class="co">#&gt; Rows read: 51 done.</span></span>
<span><span class="co">#&gt; Rows read: 2 done.</span></span>
<span><span class="co">#&gt; Rows read: 1 done.</span></span>
<span><span class="co">#&gt; Running MatrixEQTL...</span></span>
<span><span class="co">#&gt; Matching data files and location files</span></span>
<span><span class="co">#&gt; 2 of 2 genes matched</span></span>
<span><span class="co">#&gt; 51 of 51 SNPs matched</span></span>
<span><span class="co">#&gt; Task finished in 0.003 seconds</span></span>
<span><span class="co">#&gt; Processing covariates</span></span>
<span><span class="co">#&gt; Task finished in 0.002 seconds</span></span>
<span><span class="co">#&gt; Processing gene expression data (imputation, residualization)</span></span>
<span><span class="co">#&gt; Task finished in 0.002 seconds</span></span>
<span><span class="co">#&gt; Creating output file(s)</span></span>
<span><span class="co">#&gt; Task finished in 0.006 seconds</span></span>
<span><span class="co">#&gt; Performing eQTL analysis</span></span>
<span><span class="co">#&gt; 100.00% done, 102 cis-eQTLs</span></span>
<span><span class="co">#&gt; Task finished in 0.009 seconds</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Success! Stats written to: ../inst/extdata/test_results/test_cis_qtl_stats.txt</span></span>
<span><span class="co">#&gt; Mapping complete: ../inst/extdata/test_results/test_cis_qtl_stats.txt</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt;  Pipeline Complete!</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; Summary of Generated Files:</span></span>
<span><span class="co">#&gt;   [1] Segments (SAF):      ../inst/extdata/test_results/test_segments.saf</span></span>
<span><span class="co">#&gt;   [2] Raw Counts:          ../inst/extdata/test_results/test_raw_counts.txt</span></span>
<span><span class="co">#&gt;   [3] Normalized Pheno:    ../inst/extdata/test_results/test_pheno_norm.txt</span></span>
<span><span class="co">#&gt;   [4] Cis-QTL Stats:       ../inst/extdata/test_results/test_cis_qtl_stats.txt</span></span>
<span><span class="co">#&gt; =======================================================</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="explore-results">3. Explore results<a class="anchor" aria-label="anchor" href="#explore-results"></a>
</h3>
<p>The function returns a list of paths to the generated files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="co">#&gt; $saf</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/test_segments.saf"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $raw_counts</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/test_raw_counts.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $pheno</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/test_pheno_norm.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $qtl_stats</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/test_cis_qtl_stats.txt"</span></span></code></pre></div>
<div class="section level4">
<h4 id="segments">Segments<a class="anchor" aria-label="anchor" href="#segments"></a>
</h4>
<p>This file contains the segment positions that divide the whole
genome.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">saf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">saf</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, nrows <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">saf</span>, caption <span class="op">=</span> <span class="st">"Segment position (Top 5 Rows)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Segment position (Top 5 Rows)</caption>
<thead><tr class="header">
<th align="left">GeneID</th>
<th align="left">Chr</th>
<th align="right">Start</th>
<th align="right">End</th>
<th align="left">Strand</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="left">chr1</td>
<td align="right">1</td>
<td align="right">5000</td>
<td align="left">.</td>
</tr>
<tr class="even">
<td align="left">chr1_5001_10000</td>
<td align="left">chr1</td>
<td align="right">5001</td>
<td align="right">10000</td>
<td align="left">.</td>
</tr>
<tr class="odd">
<td align="left">chr1_10001_15000</td>
<td align="left">chr1</td>
<td align="right">10001</td>
<td align="right">15000</td>
<td align="left">.</td>
</tr>
<tr class="even">
<td align="left">chr1_15001_20000</td>
<td align="left">chr1</td>
<td align="right">15001</td>
<td align="right">20000</td>
<td align="left">.</td>
</tr>
<tr class="odd">
<td align="left">chr1_20001_25000</td>
<td align="left">chr1</td>
<td align="right">20001</td>
<td align="right">25000</td>
<td align="left">.</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="raw-counts">Raw counts<a class="anchor" aria-label="anchor" href="#raw-counts"></a>
</h4>
<p>This file contains raw counts within the segments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raw_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">raw_counts</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, nrows <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">raw_counts</span>, caption <span class="op">=</span> <span class="st">"Raw counts within segments (Top 5 Rows)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Raw counts within segments (Top 5 Rows)</caption>
<colgroup>
<col width="17%">
<col width="5%">
<col width="6%">
<col width="6%">
<col width="7%">
<col width="7%">
<col width="12%">
<col width="12%">
<col width="12%">
<col width="12%">
</colgroup>
<thead><tr class="header">
<th align="left">GeneID</th>
<th align="left">Chr</th>
<th align="right">Start</th>
<th align="right">End</th>
<th align="left">Strand</th>
<th align="right">Length</th>
<th align="right">Sample1.bam</th>
<th align="right">Sample2.bam</th>
<th align="right">Sample3.bam</th>
<th align="right">Sample4.bam</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="left">chr1</td>
<td align="right">1</td>
<td align="right">5000</td>
<td align="left">.</td>
<td align="right">5000</td>
<td align="right">35</td>
<td align="right">67</td>
<td align="right">35</td>
<td align="right">67</td>
</tr>
<tr class="even">
<td align="left">chr1_5001_10000</td>
<td align="left">chr1</td>
<td align="right">5001</td>
<td align="right">10000</td>
<td align="left">.</td>
<td align="right">5000</td>
<td align="right">15</td>
<td align="right">8</td>
<td align="right">15</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">chr1_10001_15000</td>
<td align="left">chr1</td>
<td align="right">10001</td>
<td align="right">15000</td>
<td align="left">.</td>
<td align="right">5000</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">chr1_15001_20000</td>
<td align="left">chr1</td>
<td align="right">15001</td>
<td align="right">20000</td>
<td align="left">.</td>
<td align="right">5000</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">chr1_20001_25000</td>
<td align="left">chr1</td>
<td align="right">20001</td>
<td align="right">25000</td>
<td align="left">.</td>
<td align="right">5000</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="normalized-phenotype-matrix">Normalized phenotype matrix<a class="anchor" aria-label="anchor" href="#normalized-phenotype-matrix"></a>
</h4>
<p>This file contains the filtered and normalized data with the segments
positions data, ready for downstream analysis e.g. QTL mapping.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">pheno</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">pheno</span>, caption <span class="op">=</span> <span class="st">"Normalized phenotype matrix (Top Rows)"</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<caption>Normalized phenotype matrix (Top Rows)</caption>
<thead><tr class="header">
<th align="left">GeneID</th>
<th align="right">Sample1</th>
<th align="right">Sample2</th>
<th align="right">Sample3</th>
<th align="right">Sample4</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="right">-0.6744898</td>
<td align="right">0.6744898</td>
<td align="right">-0.6744898</td>
<td align="right">0.6744898</td>
</tr>
<tr class="even">
<td align="left">chr1_5001_10000</td>
<td align="right">0.6744898</td>
<td align="right">-0.6744898</td>
<td align="right">0.6744898</td>
<td align="right">-0.6744898</td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="cis-qtl-summary-statistics">Cis-QTL summary statistics<a class="anchor" aria-label="anchor" href="#cis-qtl-summary-statistics"></a>
</h4>
<p>This file contains the cis-QTL mapping associations of individual
segments.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">qtl_stats</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">qtl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">qtl_stats</span>, header <span class="op">=</span> <span class="cn">TRUE</span>, nrows <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">qtl</span>, caption <span class="op">=</span> <span class="st">"Cis-QTL summary statistics (Top 5 hits)"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<table class="table">
<caption>Cis-QTL summary statistics (Top 5 hits)</caption>
<thead><tr class="header">
<th align="left">phe_id</th>
<th align="left">var_id</th>
<th align="right">z</th>
<th align="right">pval</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="left">snp_11</td>
<td align="right">Inf</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">chr1_1_5000</td>
<td align="left">snp_13</td>
<td align="right">Inf</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="left">snp_22</td>
<td align="right">-Inf</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">chr1_1_5000</td>
<td align="left">snp_33</td>
<td align="right">Inf</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">chr1_1_5000</td>
<td align="left">snp_44</td>
<td align="right">Inf</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section level2">
<h2 id="part-3-step-by-step-workflow">Part 3: Step-by-step workflow<a class="anchor" aria-label="anchor" href="#part-3-step-by-step-workflow"></a>
</h2>
<p>If you need more control (e.g., inspecting intermediate files) or
customization, you can run the individual functions included in the
whole pipeline separately.</p>
<div class="section level3">
<h3 id="step-1-create-segments">Step 1: Create segments<a class="anchor" aria-label="anchor" href="#step-1-create-segments"></a>
</h3>
<p>First, we generate a SAF (Simplified Annotation Format) file that
defines the genomic segments.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_saf</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_segments.txt"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cacti_s_create_segments.html">cacti_s_create_segments</a></span><span class="op">(</span></span>
<span>  file_saf_out <span class="op">=</span> <span class="va">file_saf</span>, <span class="co"># Output path for the SAF file.</span></span>
<span>  genome <span class="op">=</span> <span class="st">"hg19"</span>, <span class="co"># Genome build to use: "hg19" (default) or "hg38".</span></span>
<span>  segment_size <span class="op">=</span> <span class="st">"5kb"</span> <span class="co"># Character like "5kb" or numeric bp (e.g. 5000).</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Using built-in chromosome sizes for: hg19</span></span>
<span><span class="co">#&gt; Generating 5kb segments for 22 autosomes (chr1-chr22)...</span></span>
<span><span class="co">#&gt; Success! Created 576216 segments. Saved to: ../inst/extdata/test_results/test_segments.txt</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_saf</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             GeneID  Chr Start   End Strand</span></span>
<span><span class="co">#&gt; 1      chr1_1_5000 chr1     1  5000      .</span></span>
<span><span class="co">#&gt; 2  chr1_5001_10000 chr1  5001 10000      .</span></span>
<span><span class="co">#&gt; 3 chr1_10001_15000 chr1 10001 15000      .</span></span>
<span><span class="co">#&gt; 4 chr1_15001_20000 chr1 15001 20000      .</span></span>
<span><span class="co">#&gt; 5 chr1_20001_25000 chr1 20001 25000      .</span></span>
<span><span class="co">#&gt; 6 chr1_25001_30000 chr1 25001 30000      .</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-count-reads">Step 2: Count Reads<a class="anchor" aria-label="anchor" href="#step-2-count-reads"></a>
</h3>
<p>Next, we quantify reads falling into these segments for all BAM
files.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_counts</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_raw_counts.txt"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cacti_s_count.html">cacti_s_count</a></span><span class="op">(</span></span>
<span>  file_bams <span class="op">=</span> <span class="va">bam_files</span>, <span class="co"># Character vector of BAM file paths.</span></span>
<span>  file_saf <span class="op">=</span> <span class="va">file_saf</span>, <span class="co"># Path to the SAF annotation file (from \code{cacti_s_create_segments}).</span></span>
<span>  file_counts_out <span class="op">=</span> <span class="va">file_counts</span>, <span class="co"># Output path for the counts matrix.</span></span>
<span>  threads <span class="op">=</span> <span class="fl">1</span> <span class="co"># Number of threads for featureCounts.</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Counting reads for 4 BAM files...</span></span>
<span><span class="co">#&gt; Settings: SAF format | Primary Only | Ignore Dups | Read2Pos = 5</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         ==========     _____ _    _ ____  _____  ______          _____  </span></span>
<span><span class="co">#&gt;         =====         / ____| |  | |  _ \|  __ \|  ____|   /\   |  __ \ </span></span>
<span><span class="co">#&gt;           =====      | (___ | |  | | |_) | |__) | |__     /  \  | |  | |</span></span>
<span><span class="co">#&gt;             ====      \___ \| |  | |  _ &lt;|  _  /|  __|   / /\ \ | |  | |</span></span>
<span><span class="co">#&gt;               ====    ____) | |__| | |_) | | \ \| |____ / ____ \| |__| |</span></span>
<span><span class="co">#&gt;         ==========   |_____/ \____/|____/|_|  \_\______/_/    \_\_____/</span></span>
<span><span class="co">#&gt;        Rsubread 2.20.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; //========================== featureCounts setting ===========================\\</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||             Input files : 4 BAM files                                      ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||                           Sample1.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample2.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample3.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                           Sample4.bam                                      ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; ||              Paired-end : no                                               ||</span></span>
<span><span class="co">#&gt; ||        Count read pairs : no                                               ||</span></span>
<span><span class="co">#&gt; ||              Annotation : test_segments.txt (SAF)                          ||</span></span>
<span><span class="co">#&gt; ||      Dir for temp files : .                                                ||</span></span>
<span><span class="co">#&gt; ||                 Threads : 1                                                ||</span></span>
<span><span class="co">#&gt; ||                   Level : meta-feature level                               ||</span></span>
<span><span class="co">#&gt; ||      Multimapping reads : counted                                          ||</span></span>
<span><span class="co">#&gt; ||     Multiple alignments : primary alignment only                           ||</span></span>
<span><span class="co">#&gt; || Multi-overlapping reads : not counted                                      ||</span></span>
<span><span class="co">#&gt; ||   Min overlapping bases : 1                                                ||</span></span>
<span><span class="co">#&gt; ||          Read reduction : to 5' end                                        ||</span></span>
<span><span class="co">#&gt; ||        Duplicated Reads : ignored                                          ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; \\============================================================================//</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; //================================= Running ==================================\\</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Load annotation file test_segments.txt ...                                 ||</span></span>
<span><span class="co">#&gt; ||    Features : 576216                                                       ||</span></span>
<span><span class="co">#&gt; ||    Meta-features : 576216                                                  ||</span></span>
<span><span class="co">#&gt; ||    Chromosomes/contigs : 22                                                ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample1.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 50                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 50 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample2.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 75                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 75 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample3.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 50                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 50 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Process BAM file Sample4.bam...                                            ||</span></span>
<span><span class="co">#&gt; ||    Single-end reads are included.                                          ||</span></span>
<span><span class="co">#&gt; ||    Total alignments : 75                                                   ||</span></span>
<span><span class="co">#&gt; ||    Successfully assigned alignments : 75 (100.0%)                          ||</span></span>
<span><span class="co">#&gt; ||    Running time : 0.00 minutes                                             ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; || Write the final count table.                                               ||</span></span>
<span><span class="co">#&gt; || Write the read assignment summary.                                         ||</span></span>
<span><span class="co">#&gt; ||                                                                            ||</span></span>
<span><span class="co">#&gt; \\============================================================================//</span></span>
<span><span class="co">#&gt; Success! Counts written to: ../inst/extdata/test_results/test_raw_counts.txt</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_counts</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;             GeneID  Chr Start   End Strand Length Sample1.bam Sample2.bam</span></span>
<span><span class="co">#&gt; 1      chr1_1_5000 chr1     1  5000      .   5000          35          67</span></span>
<span><span class="co">#&gt; 2  chr1_5001_10000 chr1  5001 10000      .   5000          15           8</span></span>
<span><span class="co">#&gt; 3 chr1_10001_15000 chr1 10001 15000      .   5000           0           0</span></span>
<span><span class="co">#&gt; 4 chr1_15001_20000 chr1 15001 20000      .   5000           0           0</span></span>
<span><span class="co">#&gt; 5 chr1_20001_25000 chr1 20001 25000      .   5000           0           0</span></span>
<span><span class="co">#&gt; 6 chr1_25001_30000 chr1 25001 30000      .   5000           0           0</span></span>
<span><span class="co">#&gt;   Sample3.bam Sample4.bam</span></span>
<span><span class="co">#&gt; 1          35          67</span></span>
<span><span class="co">#&gt; 2          15           8</span></span>
<span><span class="co">#&gt; 3           0           0</span></span>
<span><span class="co">#&gt; 4           0           0</span></span>
<span><span class="co">#&gt; 5           0           0</span></span>
<span><span class="co">#&gt; 6           0           0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-preprocess">Step 3: Preprocess<a class="anchor" aria-label="anchor" href="#step-3-preprocess"></a>
</h3>
<p>We then perform preprocessing steps on the count data, including
-</p>
<ul>
<li>
<strong>QC:</strong> Remove segments with 0 reads in all
samples.<br>
</li>
<li>
<strong>CPM:</strong> Transform counts to log2(CPM + 0.5).<br>
</li>
<li>
<strong>Filter:</strong> Remove noise segments based on
<code>filter_mode</code>. We use the default mode:
<code>cpm_threshold</code> (keep segments with peak intensity CPM &gt; 1
in &gt; 20% of samples). We also provide other ways for filtering -
<ul>
<li>
<code>match_overlap_count</code>: Determines
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>,
the number of segments overlapping regions in <code>filter_bed</code>.
Then keeps the top
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
segments by average intensity.</li>
<li>
<code>prop</code>: Keeps the top <code>prop_top</code> proportion of
segments by average intensity.</li>
</ul>
</li>
<li>
<strong>Standardize:</strong> Z-score normalization per feature
(Mean = 0, SD = 1).<br>
</li>
<li>
<strong>RankNorm:</strong> Inverse Normal Transform per sample.</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_pheno</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_pheno_norm.txt"</span></span>
<span><span class="va">file_pheno_meta</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_pheno_norm_meta.txt"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cacti_s_preprocess.html">cacti_s_preprocess</a></span><span class="op">(</span></span>
<span>  file_raw_counts <span class="op">=</span> <span class="va">file_counts</span>, <span class="co"># Path to featureCounts output (from \code{cacti_s_count}).</span></span>
<span>  file_out <span class="op">=</span> <span class="va">file_pheno</span>, <span class="co"># Output path for the processed phenotype file.</span></span>
<span>  file_out_meta <span class="op">=</span> <span class="va">file_pheno_meta</span>, <span class="co"># Output path for the meta file of processed phenotype.</span></span>
<span>  filter_mode <span class="op">=</span> <span class="st">"cpm_threshold"</span>, <span class="co"># Strategy to select segments: "cpm_threshold" (default).</span></span>
<span>  min_cpm <span class="op">=</span> <span class="fl">1</span>, <span class="co"># (For "cpm_threshold") Minimum CPM threshold (default 1).</span></span>
<span>  min_prop <span class="op">=</span> <span class="fl">0.2</span> <span class="co"># (For "cpm_threshold") Minimum proportion of samples (default 0.2).</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; === Starting Preprocessing ===</span></span>
<span><span class="co">#&gt;   Input: ../inst/extdata/test_results/test_raw_counts.txt</span></span>
<span><span class="co">#&gt;   Filter Mode: cpm_threshold</span></span>
<span><span class="co">#&gt;   Cleaned sample names: Sample1, Sample2, Sample3...</span></span>
<span><span class="co">#&gt;   Initial Features: 576216</span></span>
<span><span class="co">#&gt;   Initial Samples:  4</span></span>
<span><span class="co">#&gt;   Features after removing all-zeros: 2</span></span>
<span><span class="co">#&gt;   Filtering by intensity: CPM &gt; 1 in &gt; 20% samples</span></span>
<span><span class="co">#&gt;   Features kept: 2</span></span>
<span><span class="co">#&gt;   Standardizing (Z-score per feature)...</span></span>
<span><span class="co">#&gt;   Rank Normalizing (INT per sample)...</span></span>
<span><span class="co">#&gt; Success! Processed data written to: ../inst/extdata/test_results/test_pheno_norm.txt</span></span>
<span><span class="co">#&gt; Success! Processed data meta written to: ../inst/extdata/test_results/test_pheno_norm_meta.txt</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_pheno</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;            GeneID    Sample1    Sample2    Sample3    Sample4</span></span>
<span><span class="co">#&gt; 1     chr1_1_5000 -0.6744898  0.6744898 -0.6744898  0.6744898</span></span>
<span><span class="co">#&gt; 2 chr1_5001_10000  0.6744898 -0.6744898  0.6744898 -0.6744898</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_pheno_meta</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;            GeneID  Chr Start   End</span></span>
<span><span class="co">#&gt; 1     chr1_1_5000 chr1     1  5000</span></span>
<span><span class="co">#&gt; 2 chr1_5001_10000 chr1  5001 10000</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-4-map-cis-qtls">Step 4: Map Cis-QTLs<a class="anchor" aria-label="anchor" href="#step-4-map-cis-qtls"></a>
</h3>
<p>Finally, we run the cis-QTL mapping using the normalized phenotype
matrix using <code>MatrixEQTL</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_qtl</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_cis_qtl_stats.txt"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/cacti_s_map_cis.html">cacti_s_map_cis</a></span><span class="op">(</span></span>
<span>  file_pheno <span class="op">=</span> <span class="va">file_pheno</span>, <span class="co"># Path to the processed phenotype file (from `cacti_s_preprocess`).</span></span>
<span>  file_pheno_meta <span class="op">=</span> <span class="va">file_pheno_meta</span>, <span class="co"># Path for the meta file of processed phenotype.</span></span>
<span>  file_cov <span class="op">=</span> <span class="va">file_cov</span>, <span class="co"># Path to covariate matrix.</span></span>
<span>  file_vcf <span class="op">=</span> <span class="va">file_vcf</span>, <span class="co"># Path to input VCF file.</span></span>
<span>  file_qtl_out <span class="op">=</span> <span class="va">file_qtl</span>, <span class="co"># Output path for summary statistics.</span></span>
<span>  cis_dist <span class="op">=</span> <span class="fl">100000</span>, <span class="co"># Cis-window distance (default 100000 bp = 100kb).</span></span>
<span>  p_threshold <span class="op">=</span> <span class="fl">1.0</span> <span class="co"># P-value threshold for output (default 1.0, print all associations).</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Preparing phenotype data...</span></span>
<span><span class="co">#&gt;   Phenotype samples: 4</span></span>
<span><span class="co">#&gt; Converting VCF to genotype matrix...</span></span>
<span><span class="co">#&gt; Preparing covariates...</span></span>
<span><span class="co">#&gt; Rows read: 51 done.</span></span>
<span><span class="co">#&gt; Rows read: 2 done.</span></span>
<span><span class="co">#&gt; Rows read: 1 done.</span></span>
<span><span class="co">#&gt; Running MatrixEQTL...</span></span>
<span><span class="co">#&gt; Matching data files and location files</span></span>
<span><span class="co">#&gt; 2 of 2 genes matched</span></span>
<span><span class="co">#&gt; 51 of 51 SNPs matched</span></span>
<span><span class="co">#&gt; Task finished in 0.002 seconds</span></span>
<span><span class="co">#&gt; Processing covariates</span></span>
<span><span class="co">#&gt; Task finished in 0.002 seconds</span></span>
<span><span class="co">#&gt; Processing gene expression data (imputation, residualization)</span></span>
<span><span class="co">#&gt; Task finished in 0.001 seconds</span></span>
<span><span class="co">#&gt; Creating output file(s)</span></span>
<span><span class="co">#&gt; Task finished in 0.004 seconds</span></span>
<span><span class="co">#&gt; Performing eQTL analysis</span></span>
<span><span class="co">#&gt; 100.00% done, 102 cis-eQTLs</span></span>
<span><span class="co">#&gt; Task finished in 0.007 seconds</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Success! Stats written to: ../inst/extdata/test_results/test_cis_qtl_stats.txt</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_qtl</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;            phe_id var_id    z          pval</span></span>
<span><span class="co">#&gt; 1     chr1_1_5000 snp_11  Inf 2.225074e-308</span></span>
<span><span class="co">#&gt; 2     chr1_1_5000 snp_13  Inf 2.225074e-308</span></span>
<span><span class="co">#&gt; 3     chr1_1_5000 snp_22 -Inf 2.225074e-308</span></span>
<span><span class="co">#&gt; 4     chr1_1_5000 snp_33  Inf 2.225074e-308</span></span>
<span><span class="co">#&gt; 5     chr1_1_5000 snp_44  Inf 2.225074e-308</span></span>
<span><span class="co">#&gt; 6 chr1_5001_10000 snp_11 -Inf 2.225074e-308</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="part-3-run-multivariate-association-with-cacti">Part 3: Run multivariate association with CACTI<a class="anchor" aria-label="anchor" href="#part-3-run-multivariate-association-with-cacti"></a>
</h2>
<p>The files generated by the CACTI-S pipeline serve as the primary
inputs for the core CACTI analysis. These include the phenotype metadata
(<code>file_pheno_meta</code>), normalized phenotypes
(<code>file_pheno</code>), covariates (<code>file_cov</code>), and the
QTL summary statistics (<code>file_qtl</code>). For more details, please
see the vignette <a href="docs/cacti_peak_window.html">here</a>.</p>
<p>With these inputs ready, we can directly run
<code><a href="../reference/cacti_run_chr.html">cacti_run_chr()</a></code> (for a single chromosome) or
<code><a href="../reference/cacti_run_genome.html">cacti_run_genome()</a></code> (for the whole genome).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_pheno</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_pheno_norm.txt"</span></span>
<span><span class="va">file_pheno_meta</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_pheno_norm_meta.txt"</span></span>
<span><span class="va">file_cov</span>   <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_cov.txt"</span></span>
<span><span class="va">file_qtl</span> <span class="op">&lt;-</span> <span class="st">"../inst/extdata/test_results/test_cis_qtl_stats.txt"</span></span>
<span><span class="va">out_prefix</span> <span class="op">&lt;-</span> <span class="st">'../inst/extdata/test_results/cactis_chr1'</span></span>
<span><span class="va">chr</span> <span class="op">&lt;-</span> <span class="st">"chr1"</span></span>
<span></span>
<span><span class="va">res_single_chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cacti_run_chr.html">cacti_run_chr</a></span><span class="op">(</span></span>
<span>  window_size     <span class="op">=</span> <span class="st">"5kb"</span>,</span>
<span>  file_pheno_meta <span class="op">=</span> <span class="va">file_pheno_meta</span>,</span>
<span>  file_pheno      <span class="op">=</span> <span class="va">file_pheno</span>,</span>
<span>  file_cov        <span class="op">=</span> <span class="va">file_cov</span>,</span>
<span>  chr             <span class="op">=</span> <span class="va">chr</span>,</span>
<span>  qtl_file        <span class="op">=</span> <span class="va">file_qtl</span>,</span>
<span>  out_prefix      <span class="op">=</span> <span class="va">out_prefix</span>,</span>
<span>  min_peaks       <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt;  CACTI Pipeline</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; Output Directory: ../inst/extdata/test_results</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 1/3] Group peaks into non-overlapping windows …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 2/3] Residualize phenotype by covariates …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [Step 3/3] Run pvalue for chr1 …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  CACTI pipeline for chr1 completed!</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; =======================================================</span></span>
<span><span class="co">#&gt; ----------- Run summary -----------</span></span>
<span><span class="co">#&gt; Chromosome:chr1</span></span>
<span><span class="co">#&gt; Window size:5kb</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  ----------- Input files -----------</span></span>
<span><span class="co">#&gt; Peaks BED:../inst/extdata/test_results/test_pheno_norm_meta.txt</span></span>
<span><span class="co">#&gt; Phenotype:../inst/extdata/test_results/test_pheno_norm.txt</span></span>
<span><span class="co">#&gt; Covariate:../inst/extdata/test_cov.txt</span></span>
<span><span class="co">#&gt; QTL summary stats:../inst/extdata/test_results/test_cis_qtl_stats.txt</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  ----------- Output files -----------</span></span>
<span><span class="co">#&gt;   [1] Grouped peak: ../inst/extdata/test_results/cactis_chr1_peak_group_window5kb.txt</span></span>
<span><span class="co">#&gt;   [2] Grouped peak (peak as row):../inst/extdata/test_results/cactis_chr1_peak_group_window5kb_peak_as_row.txt</span></span>
<span><span class="co">#&gt;   [3] Residual phenotype:../inst/extdata/test_results/cactis_chr1_pheno_cov_residual.txt</span></span>
<span><span class="co">#&gt;   [4] Pval results (chr1): ../inst/extdata/test_results/cactis_chr1_pval_window5kb_chr1.txt.gz</span></span>
<span><span class="co">#&gt; =======================================================</span></span></code></pre></div>
<p>The function returns a list containing the paths to the generated
files:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">res_single_chr</span><span class="op">)</span></span>
<span><span class="co">#&gt; $file_peak_group</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/cactis_chr1_peak_group_window5kb.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $file_peak_group_peaklevel</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/cactis_chr1_peak_group_window5kb_peak_as_row.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $file_pheno_cov_residual</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/cactis_chr1_pheno_cov_residual.txt"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $file_p_peak_group</span></span>
<span><span class="co">#&gt; [1] "../inst/extdata/test_results/cactis_chr1_pval_window5kb_chr1.txt.gz"</span></span></code></pre></div>
<p>Below is a preview of the final association statistics:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">res_single_chr</span><span class="op">$</span><span class="va">file_p_peak_group</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   group    snp pval</span></span>
<span><span class="co">#&gt; 1    G1 snp_11    0</span></span>
<span><span class="co">#&gt; 2    G1 snp_13    0</span></span>
<span><span class="co">#&gt; 3    G1 snp_22    0</span></span>
<span><span class="co">#&gt; 4    G1 snp_33    0</span></span>
<span><span class="co">#&gt; 5    G1 snp_44    0</span></span>
<span><span class="co">#&gt; 6    G1  snp_8    0</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lili Wang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
