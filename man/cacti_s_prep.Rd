% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cacti_s_prep.R
\name{cacti_s_prep}
\alias{cacti_s_prep}
\title{Run CACTI-S Prep Pipeline}
\usage{
cacti_s_prep(
  file_bams,
  file_vcf = NULL,
  file_cov = NULL,
  out_dir,
  out_prefix = "cacti_s",
  file_saf_custom = NULL,
  genome = "hg19",
  segment_size = "5kb",
  filter_mode = "cpm_threshold",
  filter_bed = NULL,
  min_cpm = 1,
  min_prop = 0.2,
  prop_top = 0.2,
  cis_dist = 1e+05,
  threads = 1,
  isPairedEnd = FALSE
)
}
\arguments{
\item{file_bams}{Character vector of file paths to the input BAM files. These should be sorted and indexed.}

\item{file_vcf}{(Optional) Path to the input VCF file containing genotype data.
Required if you want to run the mapping step.}

\item{file_cov}{(Optional) Path to the covariate matrix file.
Format: Rows are covariates (ID, S1, S2...), Columns are samples. Required if \code{file_vcf} is provided.}

\item{out_dir}{Directory path where all output files will be saved. Created automatically if it does not exist.}

\item{out_prefix}{String prefix for all generated filenames (default "cacti_s").
Files created: \code{_segments.saf}, \code{_raw_counts.txt}, \code{_pheno_norm.txt}, \code{_cis_qtl_stats.txt}, etc.}

\item{file_saf_custom}{(Optional) Path to an existing SAF file. If provided, segment generation is skipped.}

\item{genome}{Genome build to use for segment generation. Options: \code{"hg19"} (default) or \code{"hg38"}.}

\item{segment_size}{String defining the window size for tiling the genome (e.g., \code{"1kb"}, \code{"5kb"}, \code{"10kb"}).
Default is \code{"5kb"}.}

\item{filter_mode}{Strategy for selecting informative segments during preprocessing:
\itemize{
\item \code{"cpm_threshold"} (Default): Keeps segments with Counts Per Million (CPM) > \code{min_cpm}
in at least \code{min_prop} proportion of samples.
\item \code{"match_overlap_count"}: Calculates $N$, the number of segments that physically overlap
with regions in \code{filter_bed}. It then selects the top $N$ segments based on average CPM intensity.
\item \code{"prop"}: Simply keeps the top \code{prop_top} proportion of segments ranked by average CPM.
}}

\item{filter_bed}{(Required only for \code{match_overlap_count}) Path to a BED file (e.g., ATAC-seq peaks,
H3K27ac peaks, or known QTL regions) used to determine the number of segments to keep.}

\item{min_cpm}{(For \code{cpm_threshold}) Minimum CPM intensity threshold. Default 1.}

\item{min_prop}{(For \code{cpm_threshold}) Minimum proportion of samples (0-1) that must exceed \code{min_cpm}. Default 0.2.}

\item{prop_top}{(For \code{prop}) Proportion (0-1) of top-expressed segments to keep. Default 0.2.}

\item{cis_dist}{(For Mapping) The maximum distance (bp) between a gene (segment) and a SNP to be considered "cis". Default 100,000 bp.}

\item{threads}{Integer, number of threads to use for the read counting step. Default 1.}

\item{isPairedEnd}{Logical, indicating if the BAM files contain paired-end reads. Default \code{FALSE}.}
}
\value{
Invisibly returns a list containing paths to the generated files:
\itemize{
\item \code{segments.saf}: Path to the segment definition file.
\item \code{raw_counts.txt}: Path to the featureCounts output.
\item \code{pheno_norm.txt}: Path to the final normalized phenotype matrix.
\item \code{cis_qtl_stats.txt}: (If mapped) Path to the cis-QTL summary statistics.
}
}
\description{
A master wrapper function that executes the full CACTI-S preparation pipeline.
It automates the transition from raw BAM files to a normalized phenotype matrix
and optionally performs nominal cis-QTL mapping.
}
\details{
\strong{Pipeline Stages:}
\enumerate{
\item \strong{Create Segments:} Generates fixed-size genomic windows (SAF) for the specified genome build.
\item \strong{Count Reads:} Quantifies reads in these segments using \code{Rsubread::featureCounts}.
\item \strong{Preprocess:} Performs QC (removing zero-count segments), Normalization (CPM),
Filtering (different modes), Standardization (Z-score), and Rank Normalization (INT).
\item \strong{Map Cis-QTLs:} (Optional) Runs linear regression using \code{MatrixEQTL} if VCF and Covariates are provided.
}
}
\examples{
\dontrun{
# Locate test data bundled with the package
file_bam1 <- system.file("extdata", "Sample1.bam", package = "cacti")
file_bam2 <- system.file("extdata", "Sample2.bam", package = "cacti")
file_bam3 <- system.file("extdata", "Sample3.bam", package = "cacti")
file_bam4 <- system.file("extdata", "Sample4.bam", package = "cacti")
file_vcf  <- system.file("extdata", "test_geno.vcf", package = "cacti")
file_cov  <- system.file("extdata", "test_cov.txt", package = "cacti")

# Create a temporary output directory
out_dir <- "inst/extdata/test_results"

if (nchar(file_bam1) > 0) {
  # --- Run Full Pipeline (BAM -> QTL Stats) ---
  res <- cacti_s_prep(
    file_bams = c(file_bam1, file_bam2, file_bam3, file_bam4),
    file_vcf = file_vcf,
    file_cov = file_cov,

    out_dir = out_dir,
    out_prefix = "test",

    # Segment Parameters
    file_saf_custom = NULL,
    genome = "hg19",
    segment_size = "5kb",

    # Filtering Parameters
    filter_mode = "cpm_threshold",
    min_cpm = 1,
    min_prop = 0.2,

    # Execution Parameters
    threads = 1
  )
}
}
}
